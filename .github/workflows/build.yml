name: Build and publish snapshots
on:
  push:
    branches: [ win ]
  pull_request:
    branches: [ win ]

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]
    steps:
    - uses: actions/checkout@v2
      with:
        ref: javabuild

    - name: Set environment variables
      run: |
        $env:OS = "${RUNNER_OS,,}"
        $env:ARCH = "${RUNNER_ARCH,,}"
        $env:PLATFORM = "windows"
        $env:CLASSIFIER = "win-x86_64"

    - name: Download OpenJDK 19 (Windows)
      if: runner.os == 'Windows'
      run: |
        $ProgressPreference = "SilentlyContinue"
        Invoke-WebRequest https://download.java.net/java/GA/jdk19.0.1/afdd2e245b014143b62ccb916125e3ce/10/GPL/openjdk-19.0.1_windows-x64_bin.zip -OutFile jdk.zip

    - name: Setup Java and Apache Maven
      uses: actions/setup-java@v3
      with:
        distribution: jdkfile
        jdkFile: jdk.zip
        java-version: 19
        server-id: gluon-nexus
        server-username: MAVEN_USERNAME
        server-password: MAVEN_CENTRAL_TOKEN

    - name: Checkout tools repo
      run: |
        echo "print env variables"
        echo $env:OS
        echo $env:ARCH
        echo $env:PLATFORM
        echo $env:CLASSIFIER
        $env:TOOLS = "$env:GITHUB_WORKSPACE\.." | Convert-Path
        $testPath = (Test-Path -Path "$env:TOOLS\depot-tools" -PathType Container)
        If ($testPath -eq $False) { git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$env:TOOLS\depot-tools" }
        Else { Write-Host "Depot-tools already exists" }
      shell: powershell

    - name: Install rustup
      run: |
        $ProgressPreference = "SilentlyContinue"
        Invoke-WebRequest https://win.rustup.rs/ -OutFile rustup-init.exe
        .\rustup-init.exe -y --default-host=x86_64-pc-windows-msvc --profile=minimal
        del rustup-init.exe
      shell: powershell

    - name: Download and extract JEXTRACT
      run: |
        $env:TOOLS = "$env:GITHUB_WORKSPACE\.." | Convert-Path
        $ProgressPreference = "SilentlyContinue"
        Invoke-WebRequest https://download.java.net/java/early_access/jextract/2/openjdk-19-jextract+2-3_windows-x64_bin.tar.gz -OutFile jextract.tar.gz
        tar -xzf jextract.tar.gz -C $env:TOOLS
        del jextract.tar.gz
      shell: powershell

    - name: Install make
      run: |
        $env:TOOLS = "$env:GITHUB_WORKSPACE\.." | Convert-Path
        $ProgressPreference = "SilentlyContinue"
        Invoke-WebRequest https://altushost-swe.dl.sourceforge.net/project/gnuwin32/make/3.81/make-3.81-bin.zip -OutFile "$env:TOOLS\make.zip"
        Expand-Archive -LiteralPath "$env:TOOLS\make.zip" -DestinationPath "$env:TOOLS\make" -Force
        del "$env:TOOLS\make.zip"
      shell: powershell

    - name: Install python
      run: |
        $env:TOOLS = "$env:GITHUB_WORKSPACE\.." | Convert-Path
        $ProgressPreference = "SilentlyContinue"
        Invoke-WebRequest https://www.python.org/ftp/python/2.7.18/Python-2.7.18.tgz -OutFile "$env:TOOLS\python.tgz"
        tar -xzf "$env:TOOLS\python.tgz" -C $env:TOOLS
        del "$env:TOOLS\python.tgz"
      shell: powershell

    - name: Build
      run: |
        $env:TOOLS = "$env:GITHUB_WORKSPACE\.." | Convert-Path
        $env:DEPOT_TOOLS_WIN_TOOLCHAIN = 0
        $env:PATH = "$env:TOOLS\depot_tools\;$env:TOOLS\make\bin\;$env:TOOLS\Python-2.7.18;" + $env:PATH
        echo $env:PATH
        make java PLATFORM=windows JEXTRACT="$env:TOOLS\jextract-19" JDK=$env:JAVA_HOME TARGET_ARCH=x64
      shell: powershell

    - name: Deploy snapshot
      run: |
        cd src/java/tring
        mvn -Dclassifier=${{ env.CLASSIFIER }} deploy
      env:
        MAVEN_USERNAME: ${{ secrets.GLUON_NEXUS_USERNAME }}
        MAVEN_CENTRAL_TOKEN: ${{ secrets.GLUON_NEXUS_PASSWORD }}